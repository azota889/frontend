"use strict";(self.webpackChunkBalacoClient=self.webpackChunkBalacoClient||[]).push([[990],{37104:(b,R,p)=>{p.d(R,{B:()=>o});var w=p(55330),t=p(5e3),B=p(69808),D=p(87238),O=p(1033);function S(n,r){1&n&&(t.TgZ(0,"span",2),t.ALo(1,"mytranslate"),t._uU(2),t.ALo(3,"mytranslate"),t.qZA()),2&n&&(t.s9C("matTooltip",t.lcZ(1,2,"lang_auto_dat")),t.xp6(2),t.Oqu(t.lcZ(3,4,"lang_auto_d_upper")))}function M(n,r){1&n&&(t.TgZ(0,"span",2),t.ALo(1,"mytranslate"),t._uU(2),t.ALo(3,"mytranslate"),t.qZA()),2&n&&(t.s9C("matTooltip",t.lcZ(1,2,"lang_auto_chua_dat")),t.xp6(2),t.Oqu(t.lcZ(3,4,"lang_auto_cd_upper")))}function x(n,r){1&n&&(t.TgZ(0,"span",2),t.ALo(1,"mytranslate"),t._uU(2,"HT"),t.qZA()),2&n&&t.s9C("matTooltip",t.lcZ(1,1,"lang_auto_hoan_thanh"))}function I(n,r){1&n&&(t.TgZ(0,"span",2),t.ALo(1,"mytranslate"),t._uU(2,"CHT"),t.qZA()),2&n&&t.s9C("matTooltip",t.lcZ(1,1,"lang_auto_chua_hoan_thanh"))}function _(n,r){1&n&&(t.TgZ(0,"span",2),t.ALo(1,"mytranslate"),t._uU(2,"HTT"),t.qZA()),2&n&&t.s9C("matTooltip",t.lcZ(1,1,"lang_auto_hoan_thanh_tot"))}function e(n,r){if(1&n&&(t.TgZ(0,"span",3),t._uU(1),t.qZA()),2&n){const s=t.oxw();t.xp6(1),t.Oqu(s.mark)}}let o=(()=>{class n extends w.Q{constructor(){super(...arguments),this.mark=0}}return n.\u0275fac=function(){let r;return function(d){return(r||(r=t.n5z(n)))(d||n)}}(),n.\u0275cmp=t.Xpm({type:n,selectors:[["azt-check-mark"]],inputs:{mark:"mark"},features:[t.qOj],decls:6,vars:6,consts:[["class","text-mark mb-0",3,"matTooltip",4,"ngIf"],["class","text-mark mb-0",4,"ngIf"],[1,"text-mark","mb-0",3,"matTooltip"],[1,"text-mark","mb-0"]],template:function(s,d){1&s&&(t.YNc(0,S,4,6,"span",0),t.YNc(1,M,4,6,"span",0),t.YNc(2,x,3,3,"span",0),t.YNc(3,I,3,3,"span",0),t.YNc(4,_,3,3,"span",0),t.YNc(5,e,2,1,"span",1)),2&s&&(t.Q6J("ngIf","1000"==d.mark),t.xp6(1),t.Q6J("ngIf","1001"==d.mark),t.xp6(1),t.Q6J("ngIf","2000"==d.mark),t.xp6(1),t.Q6J("ngIf","2001"==d.mark),t.xp6(1),t.Q6J("ngIf","3000"==d.mark),t.xp6(1),t.Q6J("ngIf","2001"!=d.mark&&"2000"!=d.mark&&"1001"!=d.mark&&"1000"!=d.mark&&"3000"!=d.mark))},dependencies:[B.O5,D.gM,O.bT],encapsulation:2}),n})()},1643:(b,R,p)=>{p.d(R,{p:()=>A});var w=p(55330),t=p(5e3),B=p(63382),D=p(35018),O=p(69808),S=p(1033);function M(l,m){if(1&l&&(t.TgZ(0,"h3",5),t._uU(1),t.qZA()),2&l){const a=t.oxw(3);t.xp6(1),t.Oqu(a.title)}}const x=function(l){return{"rotated-img":l}},I=function(l,m,a,u){return{"width.px":l,"height.px":m,"aspect-ratio":a,transform:u}};function _(l,m){if(1&l&&(t._UZ(0,"img",9),t.ALo(1,"mycdn")),2&l){const a=t.oxw(2).$implicit,u=t.oxw(2);t.s9C("src",t.lcZ(1,4,a.backgroundImage),t.LSH),t.Q6J("ngClass",t.VKq(6,x,u.isRightRotation(a.rotation||0)))("ngStyle",t.l5B(8,I,(a.width||0)<(a.height||0)?"auto":u.isRightRotation(a.rotation||0)?a.height:a.width,(a.width||0)>(a.height||0)?"auto":u.isRightRotation(a.rotation||0)?a.width:a.height,(a.width||0)/(a.height||1),"rotate("+a.rotation+"deg)")),t.uIk("data-ratio",(a.width||0)/(a.height||1))}}function e(l,m){1&l&&(t.TgZ(0,"div",10),t._uU(1),t.ALo(2,"mytranslate"),t.qZA()),2&l&&(t.xp6(1),t.Oqu(t.lcZ(2,1,"lang_auto_dinh_dang_file_khong_ho_tro_xuat_ra_pdf_he_thong_chi_xuat_duoc_file_pdf_doi_voi_file_tai_len_dang_anh_va_pdf")))}function o(l,m){if(1&l&&(t._UZ(0,"img",11),t.ALo(1,"mycdn")),2&l){const a=t.oxw(2).$implicit;t.s9C("src",t.lcZ(1,1,a.draw),t.LSH)}}function n(l,m){if(1&l&&(t.ynx(0),t._uU(1),t.BQk()),2&l){const a=t.oxw(6);t.xp6(1),t.hij(" ",null==a.result.staticTextConfigParse?null:a.result.staticTextConfigParse.textCorrect," ")}}function r(l,m){if(1&l&&(t.ynx(0),t._uU(1),t.BQk()),2&l){const a=t.oxw(6);t.xp6(1),t.hij(" ",null==a.result.staticTextConfigParse?null:a.result.staticTextConfigParse.textWrong," ")}}function s(l,m){if(1&l&&t._UZ(0,"img",14),2&l){const a=t.oxw(6);t.s9C("src","assets/images/classlive/"+(null==a.result.staticTextConfigParse?null:a.result.staticTextConfigParse.urlImgCorrect),t.LSH)}}function d(l,m){if(1&l&&t._UZ(0,"img",14),2&l){const a=t.oxw(6);t.s9C("src","assets/images/classlive/"+(null==a.result.staticTextConfigParse?null:a.result.staticTextConfigParse.urlImgWrong),t.LSH)}}const h=function(l,m,a,u,y){return{"font-family":l,color:m,"font-size":a,position:"absolute","z-index":2,"top.px":u,"left.px":y}};function f(l,m){if(1&l&&(t.ynx(0),t.TgZ(1,"span",12),t.YNc(2,n,2,1,"ng-container",0),t.YNc(3,r,2,1,"ng-container",0),t.YNc(4,s,1,1,"img",13),t.YNc(5,d,1,1,"img",13),t.qZA(),t.BQk()),2&l){const a=m.$implicit,u=t.oxw(5);t.xp6(1),t.Q6J("ngStyle",t.qbA(5,h,null==u.result.staticTextConfigParse?null:u.result.staticTextConfigParse.fontText,null==u.result.staticTextConfigParse?null:u.result.staticTextConfigParse.fontColor,(null==u.result.staticTextConfigParse?null:u.result.staticTextConfigParse.fontSize)+"px",a.y,a.x)),t.xp6(1),t.Q6J("ngIf",(null==u.result.staticTextConfigParse?null:u.result.staticTextConfigParse.useCorrectText)&&"correct"==a.value),t.xp6(1),t.Q6J("ngIf",(null==u.result.staticTextConfigParse?null:u.result.staticTextConfigParse.useCorrectText)&&"wrong"==a.value),t.xp6(1),t.Q6J("ngIf",!(null!=u.result.staticTextConfigParse&&u.result.staticTextConfigParse.useCorrectText)&&"correct"==a.value),t.xp6(1),t.Q6J("ngIf",!(null!=u.result.staticTextConfigParse&&u.result.staticTextConfigParse.useWrongText)&&"wrong"==a.value)}}function C(l,m){if(1&l&&t.YNc(0,f,6,11,"ng-container",1),2&l){const a=t.oxw(2).$implicit;t.Q6J("ngForOf",a.staticText)}}const i=function(l,m,a,u,y,U){return{"font-family":l,color:m,"font-size":a,display:"block","line-height":1.5,position:"absolute",letterSpacing:"3px",fontWeight:"bold","z-index":3,"text-align":u,"top.px":y,"left.px":U}};function c(l,m){if(1&l&&(t.ynx(0),t._UZ(1,"span",15),t.ALo(2,"formatNoteBreak"),t.BQk()),2&l){const a=m.$implicit;t.xp6(1),t.Q6J("ngStyle",t.HTZ(4,i,a.textStyle.font,a.textStyle.color,a.textStyle.size+"px",a.textStyle.align,a.y,a.x))("innerHtml",t.lcZ(2,2,a.value),t.oJD)}}function g(l,m){if(1&l&&t.YNc(0,c,3,11,"ng-container",1),2&l){const a=t.oxw(2).$implicit;t.Q6J("ngForOf",a.objText)}}function v(l,m){if(1&l&&(t.YNc(0,_,2,13,"img",6),t.ALo(1,"isImageExtension"),t.YNc(2,e,3,3,"ng-template",null,7,t.W1O),t.YNc(4,o,2,3,"img",8),t.YNc(5,C,1,1,"ng-template",4),t.YNc(6,g,1,1,"ng-template",4)),2&l){const a=t.MAs(3),u=t.oxw().$implicit;t.Q6J("ngIf",t.lcZ(1,5,(null==u?null:u.backgroundImage)||""))("ngIfElse",a),t.xp6(4),t.Q6J("ngIf",u.draw),t.xp6(1),t.Q6J("ngIf",u.staticText&&u.staticText.length>0),t.xp6(1),t.Q6J("ngIf",u.objText&&u.objText.length>0)}}const P=function(l,m){return{position:"relative","width.px":l,"height.px":m,display:"flex","justify-content":"center","align-items":"center",margin:"0 auto"}};function T(l,m){if(1&l&&(t.ynx(0),t.TgZ(1,"div"),t.YNc(2,M,2,1,"h3",2),t.TgZ(3,"div",3),t.YNc(4,v,7,7,"ng-template",4),t.qZA()(),t.BQk()),2&l){const a=m.$implicit,u=m.first,y=t.oxw(2);t.xp6(1),t.Tol("mb-2 essayPdfImage "+y.blockItemCropClass+" "+y.blockItemEssayCropClass),t.xp6(1),t.Q6J("ngIf",u),t.xp6(1),t.Q6J("ngStyle",t.WLB(6,P,a.width,a.height)),t.xp6(1),t.Q6J("ngIf",null==a?null:a.backgroundImage)}}function E(l,m){if(1&l&&(t.ynx(0),t.YNc(1,T,5,9,"ng-container",1),t.BQk()),2&l){const a=t.oxw();t.xp6(1),t.Q6J("ngForOf",a.result.pages)}}let A=(()=>{class l extends w.Q{constructor(a,u){super(u),this.iframeService=a,this.commonService=u,this.title="\u1ea2nh b\xe0i l\xe0m t\u1ef1 lu\u1eadn",this.result={}}isRightRotation(a){return 1==Math.abs(a/90%2)}ngOnInit(){this.result.staticTextConfig&&(this.result.staticTextConfigParse=this.commonService.myParseJson(this.result.staticTextConfig)),super.ngOnInit()}ngOnChanges(){this.result.staticTextConfig&&(this.result.staticTextConfigParse=this.commonService.myParseJson(this.result.staticTextConfig))}}return l.\u0275fac=function(a){return new(a||l)(t.Y36(B.X),t.Y36(D.v))},l.\u0275cmp=t.Xpm({type:l,selectors:[["azt-export-essay-template"]],inputs:{title:"title",blockItemEssayCropClass:"blockItemEssayCropClass",blockItemCropClass:"blockItemCropClass",result:"result"},features:[t.qOj,t.TTD],decls:1,vars:1,consts:[[4,"ngIf"],[4,"ngFor","ngForOf"],["id","essayPdfTitle","class","text-center",4,"ngIf"],[3,"ngStyle"],[3,"ngIf"],["id","essayPdfTitle",1,"text-center"],["class","user-img img_respon","alt","",3,"ngClass","ngStyle","src",4,"ngIf","ngIfElse"],["noSupportExtension",""],["style","position: absolute; z-index: 1; top: 0; left: 0","class","user-img img_respon","alt","",3,"src",4,"ngIf"],["alt","",1,"user-img","img_respon",3,"ngClass","ngStyle","src"],[1,"p-2","text-center",2,"border","2px solid red"],["alt","",1,"user-img","img_respon",2,"position","absolute","z-index","1","top","0","left","0",3,"src"],[2,"min-height","50px","min-width","50px","font-weight","bold","display","flex","line-height","1.5","font-weight","bold","align-items","center","justify-content","center","text-shadow","rgb(130 126 126) 1px 1px 1px",3,"ngStyle"],["width","30","height","30","class","","alt","",3,"src",4,"ngIf"],["width","30","height","30","alt","",1,"",3,"src"],[3,"ngStyle","innerHtml"]],template:function(a,u){1&a&&t.YNc(0,E,2,1,"ng-container",0),2&a&&t.Q6J("ngIf",u.result)},dependencies:[O.mk,O.sg,O.O5,O.PC,S.bT,S.GT,S.AL,S.kJ],encapsulation:2}),l})()},296:(b,R,p)=>{p.d(R,{S:()=>x});var w=p(70655),t=p(10731),B=p(5e3),D=p(35018),O=p(15043),S=p(90893),M=p(20814);let x=(()=>{class I{constructor(e,o,n,r){this.commonService=e,this.cdnService=o,this.customQuestionAnswerConfig=n,this.exportPdfUtilsService=r}processEssayResultToBase64(e){var o,n,r,s,d;return(0,w.mG)(this,void 0,void 0,function*(){for(const h of null!==(o=e.pages)&&void 0!==o?o:[]){if(h.draw){this.cdnService.isViettelCDN(null!==(r=null===(n=e.pages)||void 0===n?void 0:n[0].backgroundImage)&&void 0!==r?r:"")&&(yield this.exportPdfUtilsService.asyncTimeout(500));const f=yield this.exportPdfUtilsService.convertAndRetryToBase64(h.draw);h.draw=f}if(this.cdnService.isViettelCDN(null!==(d=null===(s=e.pages)||void 0===s?void 0:s[0].backgroundImage)&&void 0!==d?d:"")&&(yield this.exportPdfUtilsService.asyncTimeout(500)),h.backgroundImage){const f=yield this.exportPdfUtilsService.convertAndRetryToBase64(h.backgroundImage);h.backgroundImage=f}}if(e.commentEmoji&&e.commentEmoji.length){let h="https://azota889.github.io/storage_public/mnote/",f=e.commentEmoji.length;for(let C=0;C<f;C++){let i=h+e.commentEmoji[C];const c=yield this.exportPdfUtilsService.convertAndRetryToBase64(i);e.commentEmoji[C]=c}}return e})}processGroupImagesToBase64(e,o){var n,r,s;return(0,w.mG)(this,void 0,void 0,function*(){if(e&&(null===(n=null==e?void 0:e[0].name)||void 0===n?void 0:n.startsWith("[PDFv2]")))for(const d of e)if(e[0].questionContentParse&&this.cdnService.isViettelCDN(null!==(r=e[0].questionContentParse[0].groupUrl)&&void 0!==r?r:"")&&(yield this.exportPdfUtilsService.asyncTimeout(500)),d.questionContentParse&&d.questionContentParse[0].groupUrl&&o.includes(null!==(s=d.indexLabel)&&void 0!==s?s:-1)){const h=yield this.exportPdfUtilsService.convertAndRetryToBase64(d.questionContentParse[0].groupUrl);d.questionContentParse[0].groupUrl=h}})}processQuestionImagesToBase64(e){var o,n,r,s;return(0,w.mG)(this,void 0,void 0,function*(){if(1==e[0].isImage)for(const d of e){this.cdnService.isViettelCDN(null!==(n=null===(o=e[0].questionContentParse)||void 0===o?void 0:o[0].url)&&void 0!==n?n:"")&&(yield this.exportPdfUtilsService.asyncTimeout(500));const h=yield this.exportPdfUtilsService.convertAndRetryToBase64(null!==(s=null===(r=d.questionContentParse)||void 0===r?void 0:r[0].url)&&void 0!==s?s:"");d.questionContentParse&&(d.questionContentParse[0].url=h)}})}processQuestionDocxContentToBase64(e){var o,n,r,s;return(0,w.mG)(this,void 0,void 0,function*(){if(0==e[0].isImage)for(const h of e){var d=this.exportPdfUtilsService.findImageSrcInContent(null!==(n=null===(o=h.questionContentParse)||void 0===o?void 0:o[0].content)&&void 0!==n?n:"");if(this.cdnService.isViettelCDN(d)&&(yield this.exportPdfUtilsService.asyncTimeout(500)),d&&!d.includes(";base64")){const f=yield this.exportPdfUtilsService.convertAndRetryToBase64(d);(null===(s=null===(r=h.questionContentParse)||void 0===r?void 0:r[0].content)||void 0===s?void 0:s.includes("img"))&&f&&(h.questionContentParse[0].content=h.questionContentParse[0].content.replace(d,f))}}})}convertAnswersArr(e,o){0!=e.length&&e.forEach(n=>{n.QuestionId&&n.AnswerContent&&n.AnswerContent[0]&&n.AnswerContent[0].Content&&(o[`id_${n.QuestionId}`]=n.AnswerContent[0].Content)})}parseQuestionsFor_PDFv2(e,o){var n,r;let s=this.commonService.castJsonToClassObjs(t.x,JSON.stringify(null===(n=o.data)||void 0===n?void 0:n.questionObjs));e=this.customQuestionAnswerConfig.changeQuestionContent(null!=s?s:[],!0);for(let d=0;d<e.length;d++)e[d].indexLabel=d,e[d].correctAnswer=this.commonService.filterArray(null===(r=o.data)||void 0===r?void 0:r.correctQuestionIds,e[d].id);return e}findScaleDirection(e,o){return e/o>=.7070707070707071?"w":"h"}}return I.\u0275fac=function(e){return new(e||I)(B.LFG(D.v),B.LFG(O.U),B.LFG(S.U),B.LFG(M.V))},I.\u0275prov=B.Yz7({token:I,factory:I.\u0275fac,providedIn:"root"}),I})()},16031:(b,R,p)=>{p.d(R,{I:()=>h});var w=p(70655),t=p(4159),D=p(53583),O=p(17489),M=p(5e3),x=p(296),I=p(20814),_=p(88161),e=p(72491);const d={top:60,left:60,right:60,bottom:60};let h=(()=>{class f{constructor(i,c,g,v){this.exportPdfConvertDataService=i,this.exportPdfUtilsService=c,this.answerTypeService=g,this.timeService=v,this.totalDraw=1,this.countDraw=0,this.currentPos=d,this.pdfDoc=new D.jsPDF}get loadPercent(){return Math.floor(this.countDraw/this.totalDraw*100)}getSourceCanvas(i){return(0,w.mG)(this,void 0,void 0,function*(){var c=document.getElementById(i);return yield t(c,{scale:2})})}resetPosition(i){i&&(this.currentPos={left:60,top:60,right:60,bottom:60})}drawHomeworkNoteBoxOfTeacher(i){return(0,w.mG)(this,void 0,void 0,function*(){let c=document.querySelector(".box-point.display .text-mark");if(i){i.font="25px font_chu_dep",i.fillStyle="#000",c&&i.fillText("\u0110i\u1ec3m",90,this.currentPos.top+20),i.fillText("L\u1eddi ph\xea c\u1ee7a gi\xe1o vi\xean",420,this.currentPos.top+20),this.currentPos.top+=30;let g=document.querySelector(".box-msg .note p");if(g){i.lineWidth=2,i.fillStyle="#000",i.fillRect(this.currentPos.left,this.currentPos.top,i.canvas.width-this.currentPos.left-this.currentPos.right,1);const v=this.currentPos.top;let P=window.getComputedStyle(g,null).getPropertyValue("font"),T=window.getComputedStyle(g,null).getPropertyValue("color"),E=parseInt(P.split(" ")[0].split("p")[0],10);i.font=P;let l=this.exportPdfUtilsService.essayText2LinesArr(g.innerHTML,i,i.canvas.width-60-30-(c?200:0),16,P);this.currentPos.top+=35;const m=Math.round(1.5*E),a=this.currentPos.left+(c?200:0)+15;let u=0,y=200;for(let W=0;W<l.length;W++)for(let k=0;k<l[W].length;k++){const F=l[W][k];i.font=P,i.fillStyle=T,i.fillText(F,a,this.currentPos.top),this.currentPos.top+=m,u+=m}let U=document.querySelectorAll(".box-emoji> img"),L=this.currentPos.left+(c?100:0)+15,N=this.currentPos.top,z=78,K=78,Z=15;U.forEach(W=>{var k;let F=new Image;F.src=null!==(k=W.getAttribute("src"))&&void 0!==k?k:"",F.onload=()=>{L=L+z+Z,i.drawImage(F,L,N,z,K)}});let G=30+K;if(u>y-G&&(y=u+G),i.lineWidth=2,i.fillStyle="#000",i.fillRect(this.currentPos.left,v,1,y),c&&i.fillRect(this.currentPos.left+200,v,1,y),i.fillRect(i.canvas.width-this.currentPos.right,v,1,y),i.fillRect(this.currentPos.left,v+y,i.canvas.width-this.currentPos.right-this.currentPos.left,1),c){let W=c.getBoundingClientRect().width,k=c.getBoundingClientRect().height,F=window.getComputedStyle(c,null).getPropertyValue("font"),Q=window.getComputedStyle(c,null).getPropertyValue("color");i.font=F,i.fillStyle=Q,i.fillText(c.textContent?c.textContent:"",this.currentPos.left+100-W/2,v+y/2+k/4)}this.currentPos.top=v+y+20}else{if(i.lineWidth=2,i.rect(this.currentPos.left,this.currentPos.top,i.canvas.width-this.currentPos.left-this.currentPos.right,200),i.stroke(),c&&i.fillRect(this.currentPos.left+200,this.currentPos.top,1,200),c){let v=c.getBoundingClientRect().width,P=c.getBoundingClientRect().height,T=window.getComputedStyle(c,null).getPropertyValue("font"),E=window.getComputedStyle(c,null).getPropertyValue("color");i.font=T,i.fillStyle=E,i.fillText(c.textContent?c.textContent:"",this.currentPos.left+100-v/2,this.currentPos.top+150-P/2)}this.currentPos.top+=220}}})}drawExamTitle(i){if(i){let u=document.querySelector("#mainTitle span"),y=u?window.getComputedStyle(u,null).getPropertyValue("font"):"",U=null==u?void 0:u.getBoundingClientRect().width,L=null==u?void 0:u.getBoundingClientRect().height;var c=null==u?void 0:u.querySelector("img"),g=null==c?void 0:c.getBoundingClientRect().width,v=null==c?void 0:c.getBoundingClientRect().height,P=0;if(u&&u.textContent&&U&&L&&!(c&&g&&v)){var T=(i.canvas.width-U)/2,E=this.currentPos.top+15;i.font=y,i.fillStyle="#000",i.fillText(u.textContent,T,E),P=L+20}else u&&u.textContent&&U&&L&&c&&g&&v&&(T=(i.canvas.width-U)/2,E=this.currentPos.top+20,i.font=y,i.fillStyle="#000",i.fillText(u.textContent,T,E),P=L+40,i.drawImage(c,0,0,g,v,T+(U-g)+5,this.currentPos.top-10,g,v));P>0&&(this.currentPos.top+=P,this.countDraw++)}}drawColLeftRightInHeaderOfExam(i){var c;let g=document.getElementById("colLeftInfo"),v=document.getElementById("colRightInfo"),P=g?g.querySelectorAll("h3"):void 0,T=v?v.querySelectorAll("h3"):void 0,E={top:0,left:0,right:0,bottom:0};if(i){if(i.font="16px Arial",P)for(let A=0;A<P.length;A++){0==A&&(E=O.cloneDeep(this.currentPos));const l=P[A];l.textContent&&(i.fillText(null!==(c=l.textContent)&&void 0!==c?c:"",this.currentPos.left,this.currentPos.top),this.currentPos.top+=l.getBoundingClientRect().height+5)}if(T)for(let A=0;A<T.length;A++){const l=T[A];l.textContent&&(i.fillText(l.textContent,i.canvas.width-this.currentPos.right-l.getBoundingClientRect().width,E.top),E.top+=l.getBoundingClientRect().height+5)}}}drawBlockItemToPageForExam(i,c){return(0,w.mG)(this,void 0,void 0,function*(){if(i){let v=document.querySelectorAll(`.${this.exportPdfUtilsService.blockCropItemClass}`);if(v.length>0){let P=[];for(let T=0;T<v.length;T++)P.push(T);var g=yield this.getSourceCanvas("multipleChoiceWrap");for(const T of P){const E=v[T];let A=E.classList.contains(this.exportPdfUtilsService.blockEssayCropItemClass),l=E.classList.contains("__TXT_ESSAY_PARA"),m=2*E.offsetLeft,a=2*E.offsetTop,u=2*E.getBoundingClientRect().width,y=2*E.getBoundingClientRect().height;const U=i.canvas.width-this.currentPos.left-this.currentPos.right,L=U*y/u;if(L<=i.canvas.height-this.currentPos.bottom-this.currentPos.top&&!A)this.drawSingleBlockItemToCanvas(i,g,U,L,{left:m,top:a,width:u,height:y},l);else if(this.exportPdfUtilsService.addContentToPdf(this.pdfDoc,i.canvas.toDataURL("image/jpeg",1)),this.pdfDoc.addPage(),this.exportPdfUtilsService.eraseCanvas(i),this.resetPosition(c),"h"==this.exportPdfConvertDataService.findScaleDirection(u,y)){const N=i.canvas.height-d.top-d.bottom,z=N*u/y;this.drawSingleBlockItemToCanvas(i,g,U,L,{left:m,top:a,width:u,height:y},l,(i.canvas.width-z)/2,d.top,z,N)}else this.drawSingleBlockItemToCanvas(i,g,U,L,{left:m,top:a,width:u,height:y},l)}this.exportPdfUtilsService.addContentToPdf(this.pdfDoc,i.canvas.toDataURL("image/jpeg",1))}else this.exportPdfUtilsService.addContentToPdf(this.pdfDoc,i.canvas.toDataURL("image/jpeg",1))}})}convertEssayBoxes2Canvas(i,c,g,v){return(0,w.mG)(this,void 0,void 0,function*(){let P=[];for(let T=0;T<i.length;T++)P.push(T);for(const T of P){const E=yield t(i[T]);if(0==T&&c){const m=(c.canvas.width-50-50)*E.height/E.width;v&&m>c.canvas.height-50-this.currentPos.top&&(this.exportPdfUtilsService.addContentToPdf(this.pdfDoc,c.canvas.toDataURL("image/jpeg",1)),this.exportPdfUtilsService.eraseCanvas(c),this.resetPosition(g),this.pdfDoc.addPage()),this.addEssayImage(c,i,E,T)}else this.exportPdfUtilsService.eraseCanvas(c),this.resetPosition(g),this.addEssayImage(c,i,E,T)}})}drawEssayIframeContent(i,c,g){return(0,w.mG)(this,void 0,void 0,function*(){let v=document.querySelectorAll(".essayPdfImage");if(v.length>0&&i){g||(this.exportPdfUtilsService.eraseCanvas(i),this.resetPosition(c),this.pdfDoc.addPage());let P=document.querySelector("#essayPdfTitle span");i&&P&&P.textContent&&(i.font="18px Georgia",i.fillStyle="#333",i.fillText(P.textContent,(i.canvas.width-P.getBoundingClientRect().width)/2,this.currentPos.top+20),this.currentPos.top+=P.getBoundingClientRect().height+20),yield this.convertEssayBoxes2Canvas(v,i,c,g)}})}addEssayImage(i,c,g,v){if(i){if("w"==this.exportPdfConvertDataService.findScaleDirection(g.width,g.height))i.drawImage(g,0,0,g.width,g.height,50,this.currentPos.top+50,i.canvas.width-100,(i.canvas.width-100)*g.height/g.width);else{let P=i.canvas.height-this.currentPos.top-this.currentPos.bottom,T=P*g.width/g.height;i.drawImage(g,0,0,g.width,g.height,(i.canvas.width-T)/2,this.currentPos.top,T,P)}console.log(`[_Essay_image_] V\u1ebd \u1ea3nh t\u1ef1 lu\u1eadn s\u1ed1 ${v+1}`),this.exportPdfUtilsService.addContentToPdf(this.pdfDoc,i.canvas.toDataURL("image/jpeg",1)),this.countDraw++,v!=c.length-1&&this.pdfDoc.addPage()}}drawSingleBlockItemToCanvas(i,c,g,v,P,T,E,A,l,m){T&&this.currentPos.top!=d.top&&(this.currentPos.top-=60),i.drawImage(c,P.left,P.top,P.width,P.height,E||this.currentPos.left,A||this.currentPos.top,l||g,m||v),this.currentPos.top+=v+80,this.countDraw++}examToPdf(i,c){return(0,w.mG)(this,void 0,void 0,function*(){this.countDraw=0,this.totalDraw=document.querySelectorAll(`.${this.exportPdfUtilsService.blockCropItemClass}`).length,this.pdfDoc=new D.jsPDF;let g=document.createElement("canvas"),v=document.getElementById("multipleChoiceWrap");if(v){let E=v.getBoundingClientRect().width;g.width=2*E,g.height=297*E/210*2}let P=g.getContext("2d");return this.exportPdfUtilsService.eraseCanvas(P),v&&this.resetPosition(v),v&&(yield this.drawBlockItemToPageForExam(P,v)),this.countDraw=this.totalDraw,yield this.exportPdfUtilsService.asyncTimeout(1e3),"class"==i?this.pdfDoc.output("blob"):(this.pdfDoc.save(c||"test_result.pdf"),!0)})}homeworkToPdf(){return(0,w.mG)(this,void 0,void 0,function*(){this.pdfDoc=new D.jsPDF;let i=document.createElement("canvas"),c=document.getElementById("multipleChoiceWrap");if(c){let P=c.getBoundingClientRect().width;i.width=P,i.height=297*P/210}let g=i.getContext("2d");return this.exportPdfUtilsService.eraseCanvas(g),c&&this.resetPosition(c),this.drawExamTitle(g),this.drawColLeftRightInHeaderOfExam(g),yield this.drawHomeworkNoteBoxOfTeacher(g),c&&(yield this.drawEssayIframeContent(g,c,!0)),this.pdfDoc.output("blob")})}}return f.\u0275fac=function(i){return new(i||f)(M.LFG(x.S),M.LFG(I.V),M.LFG(_.T),M.LFG(e.O))},f.\u0275prov=M.Yz7({token:f,factory:f.\u0275fac,providedIn:"root"}),f})()},20814:(b,R,p)=>{p.d(R,{V:()=>M});var w=p(70655),t=p(5e3),B=p(35018),D=p(15043),O=p(88161),S=(()=>{return(x=S||(S={}))[x.Cdn=0]="Cdn",x[x.CdnTimestamp=1]="CdnTimestamp",x[x.Rawlink=2]="Rawlink",x[x.RawlinkTimestamp=3]="RawlinkTimestamp",S;var x})();let M=(()=>{class x{constructor(_,e,o){this.commonService=_,this.cdnService=e,this.answerTypeService=o}get blockCropItemClass(){return"__CANVAS_CROP_ITEM"}get blockEssayCropItemClass(){return"_ESSAY"}isSupportedBrowswer(){var r,n,s;let e=(n=navigator.userAgent,s=n.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[],/trident/i.test(s[1])?"IE "+((r=/\brv[ :]+(\d+)/g.exec(n)||[])[1]||""):"Chrome"===s[1]&&null!=(r=n.match(/\b(OPR|Edge)\/(\d+)/))?r.slice(1).join(" ").replace("OPR","Opera"):(s=s[2]?[s[1],s[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(r=n.match(/version\/(\d+)/i))&&s.splice(1,1,r[1]),s.join(" "))).toString();return!(!["chrome"].includes(e.split(" ")[0].toLowerCase())||parseInt(e.split(" ")[1],10)<80)}getExtensionFile(_){if(!_)return"";var e=_.split(".");return e.length<=1?"":e[e.length-1].toLocaleLowerCase().split("_")[0]}translateMetaTitle(_){var e,o,n,r;let s="Export PDF: ";this.commonService.translateMetaData({title:s+(null===(o=null===(e=_.data)||void 0===e?void 0:e.examObj)||void 0===o?void 0:o.name),description:s+(null===(r=null===(n=_.data)||void 0===n?void 0:n.examObj)||void 0===r?void 0:r.name),image:"lang_cms_test_image"})}findImageSrcInContent(_){var e="";if(_.includes("img")){var o=_.indexOf("img"),n=_.indexOf("src=",o),r=_.indexOf('"',Number(n)+5);e=_.substring(Number(n)+5,Number(r))}return e}asyncTimeout(_){return(0,w.mG)(this,void 0,void 0,function*(){return`Waited ${yield new Promise(o=>{setTimeout(()=>o(_),_)})} miliseconds`})}parseEssayMarkResult(_,e,o){var n;let r=_.filter(h=>this.answerTypeService.isEssayAnswer(h.answerType));if(0!=r.length){if(e&&e.essayResult){var s=this.commonService.willDeleteParseJson(e.essayResult);if(s){var d=Object.entries(s);for(let h=0;h<r.length;h++)r[h].essayMarkParsed=d[h][1]}}for(let h=0;h<r.length;h++){let f=r[h].id,C=o.filter(c=>c.questionId==f)[0],i=this.commonService.willDeleteParseJson(null!==(n=C.config)&&void 0!==n?n:"");r[h].scorePerQuestion=i?Number(i.ScorePerQuestion):0}}}convertToBase64(_,e){return(0,w.mG)(this,void 0,void 0,function*(){let o=_;switch(e){case S.Cdn:o=this.cdnService.getMyCdn(_);break;case S.CdnTimestamp:o=this.cdnService.getMyCdn(_)+"?t="+Date.now();break;case S.RawlinkTimestamp:o=_+"?t="+Date.now()}const r=yield(yield fetch(o)).blob(),s=yield new Promise(d=>{const h=new FileReader;h.readAsDataURL(r),h.onloadend=()=>{d(h.result)}});return s&&"string"==typeof s?s:(console.log("kh\xf4ng th\u1ec3 convert url n\xe0y th\xe0nh chu\u1ed7i base64: "+_),_)})}convertAndRetryToBase64(_){return(0,w.mG)(this,void 0,void 0,function*(){let e=this.getExtensionFile(_);if(["pdf","jpg","jpeg","png","gif"].includes(e)){let o;const n=[S.Cdn,S.CdnTimestamp,S.Rawlink,S.RawlinkTimestamp];if(this.cdnService.isViettelCDN(_)){console.log(">>>> YAAAAAA, \u0111\xe2y l\xe0 link Viettel, qu\xe1 tr\xecnh convert c\xf3 th\u1ec3 l\xe2u h\u01a1n b\xecnh th\u01b0\u1eddng, v\xec ph\u1ea3i convert tu\u1ea7n t\u1ef1 sau m\u1ed7i 0.5 gi\xe2y");try{o=yield this.convertToBase64(_,n[0])}catch(r){try{yield this.asyncTimeout(500),o=yield this.convertToBase64(_,n[1])}catch(s){console.log("Kh\xf4ng th\u1ec3 convert url VIETTEL n\xe0y th\xe0nh base64 sau 2 l\u1ea7n th\u1eed: "+_),o=_}}}else try{o=yield this.convertToBase64(_,n[0])}catch(r){try{o=yield this.convertToBase64(_,n[1])}catch(s){try{o=yield this.convertToBase64(_,n[2])}catch(d){try{o=yield this.convertToBase64(_,n[3])}catch(h){console.log("Kh\xf4ng th\u1ec3 convert url n\xe0y th\xe0nh base64 sau v\xe0i l\u1ea7n retry: "+_),o=_}}}}return o}return console.log("\u0110\u1ecbnh d\u1ea1ng file kh\xf4ng \u0111\u01b0\u1ee3c h\u1ed7 tr\u1ee3: "+_),_})}eraseCanvas(_){_&&(_.beginPath(),_.rect(0,0,_.canvas.width,_.canvas.height),_.fillStyle="white",_.fill())}addContentToPdf(_,e){_.addImage(e,"JPEG",0,0,_.internal.pageSize.getWidth(),_.internal.pageSize.getHeight())}drawTextWrap(_,e,o,n,r){let s=_.split(" "),d=[],h=s[0];if(e){e.font=r||`${n}px Arial`;for(let f=1;f<s.length;f++){let C=s[f];e.measureText(h+" "+C).width<o?h+=" "+C:(d.push(h),h=C)}d.push(h)}return d}essayText2LinesArr(_,e,o,n,r){var s;let d=new RegExp("(<br>|<br/>)+","igm"),f=(null!==(s=this.commonService.replaceAllByRegExp(_,d,"<br>"))&&void 0!==s?s:"").split("<br>"),C=[];for(let i=0;i<f.length;i++)C.push(this.drawTextWrap(f[i],e,o,n,r));return C}}return x.\u0275fac=function(_){return new(_||x)(t.LFG(B.v),t.LFG(D.U),t.LFG(O.T))},x.\u0275prov=t.Yz7({token:x,factory:x.\u0275fac,providedIn:"root"}),x})()},50136:(b,R,p)=>{p.d(R,{J:()=>x});var w=p(40520),t=p(34202),B=p(51442),D=p(5e3),O=p(35018),S=p(12813),M=p(58326);let x=(()=>{class I{constructor(e,o,n){this.commonService=e,this.apiUploadService=o,this.myPdfService=n}replaceImageInContent(e){return new t.y(o=>{if(e.includes("<img ")){var n=this.findAllSubString(e,"<img"),r=[],s=[];n.forEach(d=>{var h=e.indexOf("src=",d),f=e.indexOf('"',Number(h)+5),C=e.substring(Number(h)+5,Number(f)+1);C.includes(";base64")?r.push({oldUrl:C}):C.includes("blob:")&&s.push({oldUrl:C})}),r.length>0?this.reUploadBase64File(r,(d,h)=>{null!=h?this.reUploadBlobFile(s,(f,C)=>{null!=C?(e=this.replaceHomeworkContent(e,d),e=this.replaceHomeworkContent(e,f),o.next({errorMessage:void 0,content:e}),o.complete()):(o.next({errorMessage:C,content:e}),o.complete())}):(o.next({errorMessage:h,content:e}),o.complete())}):s.length>0?this.reUploadBlobFile(s,(d,h)=>{null!=h?(e=this.replaceHomeworkContent(e,d),o.next({errorMessage:void 0,content:e}),o.complete()):(o.next({errorMessage:h,content:e}),o.complete())}):(e=this.replaceHomeworkContent(e,[]),o.next({errorMessage:void 0,content:e}),o.complete())}else o.next({errorMessage:void 0,content:e}),o.complete()})}replaceHomeworkContent(e,o){return o.length>0&&o.forEach(n=>{var r,s=e.replace(null!==(r=n.oldUrl)&&void 0!==r?r:"  ",n.newUrl+'" class="w-100 img-fluid"');e=s}),e}findAllSubString(e,o){for(var n=0,r=0,s=[];e.indexOf(o,n)>-1;)r=e.indexOf(o,n),s.push(r),n=r+o.length;return s}getTypeFile(e){var o=e.indexOf(";");return e.substring(5,o)}getFileName(e){var o=e.split("").reverse().join(""),n=o.indexOf(";"),r=o.indexOf("/",n);return o.substring(n,r).split("").reverse().join("")}convertBlobToBase64(e){return new Promise(o=>{var n=new Image;n.crossOrigin="Anonymous",n.addEventListener("load",function(){var r=document.createElement("canvas"),s=r.getContext("2d");r.width=n.width,r.height=n.height,null==s||s.drawImage(n,0,0);var d=r.toDataURL("image/png");o(d)},!1),n.src=e})}reUploadBase64File(e,o){var n;if(e&&e.length>0){let h,d=e.length;for(var r=[],s=0;s<e.length;s++){const f=e[s],C=null===(n=f.oldUrl)||void 0===n?void 0:n.substring(0,f.oldUrl.length-1);this.startUploadBlobFile(f,null!=C?C:"",[],(i,c)=>{null==c?r=r.concat(i):h=c,d-=1,0==d&&o(r,h)})}}else o([],"lang_auto_khong_upload_duoc_anh_vui_long_thu_lai_sau")}reUploadBlobFile(e,o){var n;if(e&&e.length>0){let h,d=e.length;for(var r=[],s=0;s<e.length;s++){const f=e[s],C=null===(n=null==f?void 0:f.oldUrl)||void 0===n?void 0:n.substring(0,f.oldUrl.length-1);this.convertBlobToBase64(null!=C?C:"").then(i=>{this.startUploadBlobFile(f,i,[],(c,g)=>{null==g?r=r.concat(c):h=g,d-=1,0==d&&o(r,h)})})}}else o([],"lang_auto_khong_upload_duoc_anh_vui_long_thu_lai_sau")}startUploadBlobFile(e,o,n,r){if(o&&""!=o){var s=this.getTypeFile(o),d=this.myPdfService.b64toFile(o,this.getFileName(s),s);(0,B.hv)(d).then(h=>{this.apiUploadService.uploadToCdnForHomework(h).subscribe(f=>{var C,i;if(f.type!=w.dt.UploadProgress)if(1==f.success){var c=Object.assign(Object.assign({},e),{newUrl:null!==(i=null===(C=f.data)||void 0===C?void 0:C.url)&&void 0!==i?i:""});n.push(c),r(n,void 0)}else r(n,"lang_auto_khong_upload_duoc_anh_vui_long_thu_lai_sau_loi[SPLIT_LANG] [SPLIT_LANG]"+f.message)})})}else r(n,"lang_auto_khong_upload_duoc_anh_vui_long_thu_lai_sau")}}return I.\u0275fac=function(e){return new(e||I)(D.LFG(O.v),D.LFG(S.$),D.LFG(M.t))},I.\u0275prov=D.Yz7({token:I,factory:I.\u0275fac,providedIn:"root"}),I})()}}]);