"use strict";(self.webpackChunkBalacoClient=self.webpackChunkBalacoClient||[]).push([[237],{1643:(N,L,p)=>{p.d(L,{p:()=>w});var S=p(55330),t=p(5e3),R=p(63382),A=p(35018),B=p(69808),I=p(1033);function M(l,v){if(1&l&&(t.TgZ(0,"h3",5),t._uU(1),t.qZA()),2&l){const s=t.oxw(3);t.xp6(1),t.Oqu(s.title)}}const y=function(l){return{"rotated-img":l}},D=function(l,v,s,_){return{"width.px":l,"height.px":v,"aspect-ratio":s,transform:_}};function d(l,v){if(1&l&&(t._UZ(0,"img",9),t.ALo(1,"mycdn")),2&l){const s=t.oxw(2).$implicit,_=t.oxw(2);t.s9C("src",t.lcZ(1,4,s.backgroundImage),t.LSH),t.Q6J("ngClass",t.VKq(6,y,_.isRightRotation(s.rotation||0)))("ngStyle",t.l5B(8,D,(s.width||0)<(s.height||0)?"auto":_.isRightRotation(s.rotation||0)?s.height:s.width,(s.width||0)>(s.height||0)?"auto":_.isRightRotation(s.rotation||0)?s.width:s.height,(s.width||0)/(s.height||1),"rotate("+s.rotation+"deg)")),t.uIk("data-ratio",(s.width||0)/(s.height||1))}}function e(l,v){1&l&&(t.TgZ(0,"div",10),t._uU(1),t.ALo(2,"mytranslate"),t.qZA()),2&l&&(t.xp6(1),t.Oqu(t.lcZ(2,1,"lang_auto_dinh_dang_file_khong_ho_tro_xuat_ra_pdf_he_thong_chi_xuat_duoc_file_pdf_doi_voi_file_tai_len_dang_anh_va_pdf")))}function i(l,v){if(1&l&&(t._UZ(0,"img",11),t.ALo(1,"mycdn")),2&l){const s=t.oxw(2).$implicit;t.s9C("src",t.lcZ(1,1,s.draw),t.LSH)}}function o(l,v){if(1&l&&(t.ynx(0),t._uU(1),t.BQk()),2&l){const s=t.oxw(6);t.xp6(1),t.hij(" ",null==s.result.staticTextConfigParse?null:s.result.staticTextConfigParse.textCorrect," ")}}function r(l,v){if(1&l&&(t.ynx(0),t._uU(1),t.BQk()),2&l){const s=t.oxw(6);t.xp6(1),t.hij(" ",null==s.result.staticTextConfigParse?null:s.result.staticTextConfigParse.textWrong," ")}}function c(l,v){if(1&l&&t._UZ(0,"img",14),2&l){const s=t.oxw(6);t.s9C("src","assets/images/classlive/"+(null==s.result.staticTextConfigParse?null:s.result.staticTextConfigParse.urlImgCorrect),t.LSH)}}function u(l,v){if(1&l&&t._UZ(0,"img",14),2&l){const s=t.oxw(6);t.s9C("src","assets/images/classlive/"+(null==s.result.staticTextConfigParse?null:s.result.staticTextConfigParse.urlImgWrong),t.LSH)}}const h=function(l,v,s,_,x){return{"font-family":l,color:v,"font-size":s,position:"absolute","z-index":2,"top.px":_,"left.px":x}};function f(l,v){if(1&l&&(t.ynx(0),t.TgZ(1,"span",12),t.YNc(2,o,2,1,"ng-container",0),t.YNc(3,r,2,1,"ng-container",0),t.YNc(4,c,1,1,"img",13),t.YNc(5,u,1,1,"img",13),t.qZA(),t.BQk()),2&l){const s=v.$implicit,_=t.oxw(5);t.xp6(1),t.Q6J("ngStyle",t.qbA(5,h,null==_.result.staticTextConfigParse?null:_.result.staticTextConfigParse.fontText,null==_.result.staticTextConfigParse?null:_.result.staticTextConfigParse.fontColor,(null==_.result.staticTextConfigParse?null:_.result.staticTextConfigParse.fontSize)+"px",s.y,s.x)),t.xp6(1),t.Q6J("ngIf",(null==_.result.staticTextConfigParse?null:_.result.staticTextConfigParse.useCorrectText)&&"correct"==s.value),t.xp6(1),t.Q6J("ngIf",(null==_.result.staticTextConfigParse?null:_.result.staticTextConfigParse.useCorrectText)&&"wrong"==s.value),t.xp6(1),t.Q6J("ngIf",!(null!=_.result.staticTextConfigParse&&_.result.staticTextConfigParse.useCorrectText)&&"correct"==s.value),t.xp6(1),t.Q6J("ngIf",!(null!=_.result.staticTextConfigParse&&_.result.staticTextConfigParse.useWrongText)&&"wrong"==s.value)}}function C(l,v){if(1&l&&t.YNc(0,f,6,11,"ng-container",1),2&l){const s=t.oxw(2).$implicit;t.Q6J("ngForOf",s.staticText)}}const n=function(l,v,s,_,x,O){return{"font-family":l,color:v,"font-size":s,display:"block","line-height":1.5,position:"absolute",letterSpacing:"3px",fontWeight:"bold","z-index":3,"text-align":_,"top.px":x,"left.px":O}};function a(l,v){if(1&l&&(t.ynx(0),t._UZ(1,"span",15),t.ALo(2,"formatNoteBreak"),t.BQk()),2&l){const s=v.$implicit;t.xp6(1),t.Q6J("ngStyle",t.HTZ(4,n,s.textStyle.font,s.textStyle.color,s.textStyle.size+"px",s.textStyle.align,s.y,s.x))("innerHtml",t.lcZ(2,2,s.value),t.oJD)}}function g(l,v){if(1&l&&t.YNc(0,a,3,11,"ng-container",1),2&l){const s=t.oxw(2).$implicit;t.Q6J("ngForOf",s.objText)}}function m(l,v){if(1&l&&(t.YNc(0,d,2,13,"img",6),t.ALo(1,"isImageExtension"),t.YNc(2,e,3,3,"ng-template",null,7,t.W1O),t.YNc(4,i,2,3,"img",8),t.YNc(5,C,1,1,"ng-template",4),t.YNc(6,g,1,1,"ng-template",4)),2&l){const s=t.MAs(3),_=t.oxw().$implicit;t.Q6J("ngIf",t.lcZ(1,5,(null==_?null:_.backgroundImage)||""))("ngIfElse",s),t.xp6(4),t.Q6J("ngIf",_.draw),t.xp6(1),t.Q6J("ngIf",_.staticText&&_.staticText.length>0),t.xp6(1),t.Q6J("ngIf",_.objText&&_.objText.length>0)}}const P=function(l,v){return{position:"relative","width.px":l,"height.px":v,display:"flex","justify-content":"center","align-items":"center",margin:"0 auto"}};function T(l,v){if(1&l&&(t.ynx(0),t.TgZ(1,"div"),t.YNc(2,M,2,1,"h3",2),t.TgZ(3,"div",3),t.YNc(4,m,7,7,"ng-template",4),t.qZA()(),t.BQk()),2&l){const s=v.$implicit,_=v.first,x=t.oxw(2);t.xp6(1),t.Tol("mb-2 essayPdfImage "+x.blockItemCropClass+" "+x.blockItemEssayCropClass),t.xp6(1),t.Q6J("ngIf",_),t.xp6(1),t.Q6J("ngStyle",t.WLB(6,P,s.width,s.height)),t.xp6(1),t.Q6J("ngIf",null==s?null:s.backgroundImage)}}function E(l,v){if(1&l&&(t.ynx(0),t.YNc(1,T,5,9,"ng-container",1),t.BQk()),2&l){const s=t.oxw();t.xp6(1),t.Q6J("ngForOf",s.result.pages)}}let w=(()=>{class l extends S.Q{constructor(s,_){super(_),this.iframeService=s,this.commonService=_,this.title="\u1ea2nh b\xe0i l\xe0m t\u1ef1 lu\u1eadn",this.result={}}isRightRotation(s){return 1==Math.abs(s/90%2)}ngOnInit(){this.result.staticTextConfig&&(this.result.staticTextConfigParse=this.commonService.myParseJson(this.result.staticTextConfig)),super.ngOnInit()}ngOnChanges(){this.result.staticTextConfig&&(this.result.staticTextConfigParse=this.commonService.myParseJson(this.result.staticTextConfig))}}return l.\u0275fac=function(s){return new(s||l)(t.Y36(R.X),t.Y36(A.v))},l.\u0275cmp=t.Xpm({type:l,selectors:[["azt-export-essay-template"]],inputs:{title:"title",blockItemEssayCropClass:"blockItemEssayCropClass",blockItemCropClass:"blockItemCropClass",result:"result"},features:[t.qOj,t.TTD],decls:1,vars:1,consts:[[4,"ngIf"],[4,"ngFor","ngForOf"],["id","essayPdfTitle","class","text-center",4,"ngIf"],[3,"ngStyle"],[3,"ngIf"],["id","essayPdfTitle",1,"text-center"],["class","user-img img_respon","alt","",3,"ngClass","ngStyle","src",4,"ngIf","ngIfElse"],["noSupportExtension",""],["style","position: absolute; z-index: 1; top: 0; left: 0","class","user-img img_respon","alt","",3,"src",4,"ngIf"],["alt","",1,"user-img","img_respon",3,"ngClass","ngStyle","src"],[1,"p-2","text-center",2,"border","2px solid red"],["alt","",1,"user-img","img_respon",2,"position","absolute","z-index","1","top","0","left","0",3,"src"],[2,"min-height","50px","min-width","50px","font-weight","bold","display","flex","line-height","1.5","font-weight","bold","align-items","center","justify-content","center","text-shadow","rgb(130 126 126) 1px 1px 1px",3,"ngStyle"],["width","30","height","30","class","","alt","",3,"src",4,"ngIf"],["width","30","height","30","alt","",1,"",3,"src"],[3,"ngStyle","innerHtml"]],template:function(s,_){1&s&&t.YNc(0,E,2,1,"ng-container",0),2&s&&t.Q6J("ngIf",_.result)},dependencies:[B.mk,B.sg,B.O5,B.PC,I.bT,I.GT,I.AL,I.kJ],encapsulation:2}),l})()},296:(N,L,p)=>{p.d(L,{S:()=>y});var S=p(70655),t=p(10731),R=p(5e3),A=p(35018),B=p(15043),I=p(90893),M=p(20814);let y=(()=>{class D{constructor(e,i,o,r){this.commonService=e,this.cdnService=i,this.customQuestionAnswerConfig=o,this.exportPdfUtilsService=r}processEssayResultToBase64(e){var i,o,r,c,u;return(0,S.mG)(this,void 0,void 0,function*(){for(const h of null!==(i=e.pages)&&void 0!==i?i:[]){if(h.draw){this.cdnService.isViettelCDN(null!==(r=null===(o=e.pages)||void 0===o?void 0:o[0].backgroundImage)&&void 0!==r?r:"")&&(yield this.exportPdfUtilsService.asyncTimeout(500));const f=yield this.exportPdfUtilsService.convertAndRetryToBase64(h.draw);h.draw=f}if(this.cdnService.isViettelCDN(null!==(u=null===(c=e.pages)||void 0===c?void 0:c[0].backgroundImage)&&void 0!==u?u:"")&&(yield this.exportPdfUtilsService.asyncTimeout(500)),h.backgroundImage){const f=yield this.exportPdfUtilsService.convertAndRetryToBase64(h.backgroundImage);h.backgroundImage=f}}if(e.commentEmoji&&e.commentEmoji.length){let h="https://azota889.github.io/storage_public/mnote/",f=e.commentEmoji.length;for(let C=0;C<f;C++){let n=h+e.commentEmoji[C];const a=yield this.exportPdfUtilsService.convertAndRetryToBase64(n);e.commentEmoji[C]=a}}return e})}processGroupImagesToBase64(e,i){var o,r,c;return(0,S.mG)(this,void 0,void 0,function*(){if(e&&(null===(o=null==e?void 0:e[0].name)||void 0===o?void 0:o.startsWith("[PDFv2]")))for(const u of e)if(e[0].questionContentParse&&this.cdnService.isViettelCDN(null!==(r=e[0].questionContentParse[0].groupUrl)&&void 0!==r?r:"")&&(yield this.exportPdfUtilsService.asyncTimeout(500)),u.questionContentParse&&u.questionContentParse[0].groupUrl&&i.includes(null!==(c=u.indexLabel)&&void 0!==c?c:-1)){const h=yield this.exportPdfUtilsService.convertAndRetryToBase64(u.questionContentParse[0].groupUrl);u.questionContentParse[0].groupUrl=h}})}processQuestionImagesToBase64(e){var i,o,r,c;return(0,S.mG)(this,void 0,void 0,function*(){if(1==e[0].isImage)for(const u of e){this.cdnService.isViettelCDN(null!==(o=null===(i=e[0].questionContentParse)||void 0===i?void 0:i[0].url)&&void 0!==o?o:"")&&(yield this.exportPdfUtilsService.asyncTimeout(500));const h=yield this.exportPdfUtilsService.convertAndRetryToBase64(null!==(c=null===(r=u.questionContentParse)||void 0===r?void 0:r[0].url)&&void 0!==c?c:"");u.questionContentParse&&(u.questionContentParse[0].url=h)}})}processQuestionDocxContentToBase64(e){var i,o,r,c;return(0,S.mG)(this,void 0,void 0,function*(){if(0==e[0].isImage)for(const h of e){var u=this.exportPdfUtilsService.findImageSrcInContent(null!==(o=null===(i=h.questionContentParse)||void 0===i?void 0:i[0].content)&&void 0!==o?o:"");if(this.cdnService.isViettelCDN(u)&&(yield this.exportPdfUtilsService.asyncTimeout(500)),u&&!u.includes(";base64")){const f=yield this.exportPdfUtilsService.convertAndRetryToBase64(u);(null===(c=null===(r=h.questionContentParse)||void 0===r?void 0:r[0].content)||void 0===c?void 0:c.includes("img"))&&f&&(h.questionContentParse[0].content=h.questionContentParse[0].content.replace(u,f))}}})}convertAnswersArr(e,i){0!=e.length&&e.forEach(o=>{o.QuestionId&&o.AnswerContent&&o.AnswerContent[0]&&o.AnswerContent[0].Content&&(i[`id_${o.QuestionId}`]=o.AnswerContent[0].Content)})}parseQuestionsFor_PDFv2(e,i){var o,r;let c=this.commonService.castJsonToClassObjs(t.x,JSON.stringify(null===(o=i.data)||void 0===o?void 0:o.questionObjs));e=this.customQuestionAnswerConfig.changeQuestionContent(null!=c?c:[],!0);for(let u=0;u<e.length;u++)e[u].indexLabel=u,e[u].correctAnswer=this.commonService.filterArray(null===(r=i.data)||void 0===r?void 0:r.correctQuestionIds,e[u].id);return e}findScaleDirection(e,i){return e/i>=.7070707070707071?"w":"h"}}return D.\u0275fac=function(e){return new(e||D)(R.LFG(A.v),R.LFG(B.U),R.LFG(I.U),R.LFG(M.V))},D.\u0275prov=R.Yz7({token:D,factory:D.\u0275fac,providedIn:"root"}),D})()},16031:(N,L,p)=>{p.d(L,{I:()=>h});var S=p(70655),t=p(4159),A=p(53583),B=p(17489),M=p(5e3),y=p(296),D=p(20814),d=p(88161),e=p(72491);const u={top:60,left:60,right:60,bottom:60};let h=(()=>{class f{constructor(n,a,g,m){this.exportPdfConvertDataService=n,this.exportPdfUtilsService=a,this.answerTypeService=g,this.timeService=m,this.totalDraw=1,this.countDraw=0,this.currentPos=u,this.pdfDoc=new A.jsPDF}get loadPercent(){return Math.floor(this.countDraw/this.totalDraw*100)}getSourceCanvas(n){return(0,S.mG)(this,void 0,void 0,function*(){var a=document.getElementById(n);return yield t(a,{scale:2})})}resetPosition(n){n&&(this.currentPos={left:60,top:60,right:60,bottom:60})}drawHomeworkNoteBoxOfTeacher(n){return(0,S.mG)(this,void 0,void 0,function*(){let a=document.querySelector(".box-point.display .text-mark");if(n){n.font="25px font_chu_dep",n.fillStyle="#000",a&&n.fillText("\u0110i\u1ec3m",90,this.currentPos.top+20),n.fillText("L\u1eddi ph\xea c\u1ee7a gi\xe1o vi\xean",420,this.currentPos.top+20),this.currentPos.top+=30;let g=document.querySelector(".box-msg .note p");if(g){n.lineWidth=2,n.fillStyle="#000",n.fillRect(this.currentPos.left,this.currentPos.top,n.canvas.width-this.currentPos.left-this.currentPos.right,1);const m=this.currentPos.top;let P=window.getComputedStyle(g,null).getPropertyValue("font"),T=window.getComputedStyle(g,null).getPropertyValue("color"),E=parseInt(P.split(" ")[0].split("p")[0],10);n.font=P;let l=this.exportPdfUtilsService.essayText2LinesArr(g.innerHTML,n,n.canvas.width-60-30-(a?200:0),16,P);this.currentPos.top+=35;const v=Math.round(1.5*E),s=this.currentPos.left+(a?200:0)+15;let _=0,x=200;for(let W=0;W<l.length;W++)for(let k=0;k<l[W].length;k++){const F=l[W][k];n.font=P,n.fillStyle=T,n.fillText(F,s,this.currentPos.top),this.currentPos.top+=v,_+=v}let O=document.querySelectorAll(".box-emoji> img"),U=this.currentPos.left+(a?100:0)+15,G=this.currentPos.top,b=78,K=78,z=15;O.forEach(W=>{var k;let F=new Image;F.src=null!==(k=W.getAttribute("src"))&&void 0!==k?k:"",F.onload=()=>{U=U+b+z,n.drawImage(F,U,G,b,K)}});let j=30+K;if(_>x-j&&(x=_+j),n.lineWidth=2,n.fillStyle="#000",n.fillRect(this.currentPos.left,m,1,x),a&&n.fillRect(this.currentPos.left+200,m,1,x),n.fillRect(n.canvas.width-this.currentPos.right,m,1,x),n.fillRect(this.currentPos.left,m+x,n.canvas.width-this.currentPos.right-this.currentPos.left,1),a){let W=a.getBoundingClientRect().width,k=a.getBoundingClientRect().height,F=window.getComputedStyle(a,null).getPropertyValue("font"),H=window.getComputedStyle(a,null).getPropertyValue("color");n.font=F,n.fillStyle=H,n.fillText(a.textContent?a.textContent:"",this.currentPos.left+100-W/2,m+x/2+k/4)}this.currentPos.top=m+x+20}else{if(n.lineWidth=2,n.rect(this.currentPos.left,this.currentPos.top,n.canvas.width-this.currentPos.left-this.currentPos.right,200),n.stroke(),a&&n.fillRect(this.currentPos.left+200,this.currentPos.top,1,200),a){let m=a.getBoundingClientRect().width,P=a.getBoundingClientRect().height,T=window.getComputedStyle(a,null).getPropertyValue("font"),E=window.getComputedStyle(a,null).getPropertyValue("color");n.font=T,n.fillStyle=E,n.fillText(a.textContent?a.textContent:"",this.currentPos.left+100-m/2,this.currentPos.top+150-P/2)}this.currentPos.top+=220}}})}drawExamTitle(n){if(n){let _=document.querySelector("#mainTitle span"),x=_?window.getComputedStyle(_,null).getPropertyValue("font"):"",O=null==_?void 0:_.getBoundingClientRect().width,U=null==_?void 0:_.getBoundingClientRect().height;var a=null==_?void 0:_.querySelector("img"),g=null==a?void 0:a.getBoundingClientRect().width,m=null==a?void 0:a.getBoundingClientRect().height,P=0;if(_&&_.textContent&&O&&U&&!(a&&g&&m)){var T=(n.canvas.width-O)/2,E=this.currentPos.top+15;n.font=x,n.fillStyle="#000",n.fillText(_.textContent,T,E),P=U+20}else _&&_.textContent&&O&&U&&a&&g&&m&&(T=(n.canvas.width-O)/2,E=this.currentPos.top+20,n.font=x,n.fillStyle="#000",n.fillText(_.textContent,T,E),P=U+40,n.drawImage(a,0,0,g,m,T+(O-g)+5,this.currentPos.top-10,g,m));P>0&&(this.currentPos.top+=P,this.countDraw++)}}drawColLeftRightInHeaderOfExam(n){var a;let g=document.getElementById("colLeftInfo"),m=document.getElementById("colRightInfo"),P=g?g.querySelectorAll("h3"):void 0,T=m?m.querySelectorAll("h3"):void 0,E={top:0,left:0,right:0,bottom:0};if(n){if(n.font="16px Arial",P)for(let w=0;w<P.length;w++){0==w&&(E=B.cloneDeep(this.currentPos));const l=P[w];l.textContent&&(n.fillText(null!==(a=l.textContent)&&void 0!==a?a:"",this.currentPos.left,this.currentPos.top),this.currentPos.top+=l.getBoundingClientRect().height+5)}if(T)for(let w=0;w<T.length;w++){const l=T[w];l.textContent&&(n.fillText(l.textContent,n.canvas.width-this.currentPos.right-l.getBoundingClientRect().width,E.top),E.top+=l.getBoundingClientRect().height+5)}}}drawBlockItemToPageForExam(n,a){return(0,S.mG)(this,void 0,void 0,function*(){if(n){let m=document.querySelectorAll(`.${this.exportPdfUtilsService.blockCropItemClass}`);if(m.length>0){let P=[];for(let T=0;T<m.length;T++)P.push(T);var g=yield this.getSourceCanvas("multipleChoiceWrap");for(const T of P){const E=m[T];let w=E.classList.contains(this.exportPdfUtilsService.blockEssayCropItemClass),l=E.classList.contains("__TXT_ESSAY_PARA"),v=2*E.offsetLeft,s=2*E.offsetTop,_=2*E.getBoundingClientRect().width,x=2*E.getBoundingClientRect().height;const O=n.canvas.width-this.currentPos.left-this.currentPos.right,U=O*x/_;if(U<=n.canvas.height-this.currentPos.bottom-this.currentPos.top&&!w)this.drawSingleBlockItemToCanvas(n,g,O,U,{left:v,top:s,width:_,height:x},l);else if(this.exportPdfUtilsService.addContentToPdf(this.pdfDoc,n.canvas.toDataURL("image/jpeg",1)),this.pdfDoc.addPage(),this.exportPdfUtilsService.eraseCanvas(n),this.resetPosition(a),"h"==this.exportPdfConvertDataService.findScaleDirection(_,x)){const G=n.canvas.height-u.top-u.bottom,b=G*_/x;this.drawSingleBlockItemToCanvas(n,g,O,U,{left:v,top:s,width:_,height:x},l,(n.canvas.width-b)/2,u.top,b,G)}else this.drawSingleBlockItemToCanvas(n,g,O,U,{left:v,top:s,width:_,height:x},l)}this.exportPdfUtilsService.addContentToPdf(this.pdfDoc,n.canvas.toDataURL("image/jpeg",1))}else this.exportPdfUtilsService.addContentToPdf(this.pdfDoc,n.canvas.toDataURL("image/jpeg",1))}})}convertEssayBoxes2Canvas(n,a,g,m){return(0,S.mG)(this,void 0,void 0,function*(){let P=[];for(let T=0;T<n.length;T++)P.push(T);for(const T of P){const E=yield t(n[T]);if(0==T&&a){const v=(a.canvas.width-50-50)*E.height/E.width;m&&v>a.canvas.height-50-this.currentPos.top&&(this.exportPdfUtilsService.addContentToPdf(this.pdfDoc,a.canvas.toDataURL("image/jpeg",1)),this.exportPdfUtilsService.eraseCanvas(a),this.resetPosition(g),this.pdfDoc.addPage()),this.addEssayImage(a,n,E,T)}else this.exportPdfUtilsService.eraseCanvas(a),this.resetPosition(g),this.addEssayImage(a,n,E,T)}})}drawEssayIframeContent(n,a,g){return(0,S.mG)(this,void 0,void 0,function*(){let m=document.querySelectorAll(".essayPdfImage");if(m.length>0&&n){g||(this.exportPdfUtilsService.eraseCanvas(n),this.resetPosition(a),this.pdfDoc.addPage());let P=document.querySelector("#essayPdfTitle span");n&&P&&P.textContent&&(n.font="18px Georgia",n.fillStyle="#333",n.fillText(P.textContent,(n.canvas.width-P.getBoundingClientRect().width)/2,this.currentPos.top+20),this.currentPos.top+=P.getBoundingClientRect().height+20),yield this.convertEssayBoxes2Canvas(m,n,a,g)}})}addEssayImage(n,a,g,m){if(n){if("w"==this.exportPdfConvertDataService.findScaleDirection(g.width,g.height))n.drawImage(g,0,0,g.width,g.height,50,this.currentPos.top+50,n.canvas.width-100,(n.canvas.width-100)*g.height/g.width);else{let P=n.canvas.height-this.currentPos.top-this.currentPos.bottom,T=P*g.width/g.height;n.drawImage(g,0,0,g.width,g.height,(n.canvas.width-T)/2,this.currentPos.top,T,P)}console.log(`[_Essay_image_] V\u1ebd \u1ea3nh t\u1ef1 lu\u1eadn s\u1ed1 ${m+1}`),this.exportPdfUtilsService.addContentToPdf(this.pdfDoc,n.canvas.toDataURL("image/jpeg",1)),this.countDraw++,m!=a.length-1&&this.pdfDoc.addPage()}}drawSingleBlockItemToCanvas(n,a,g,m,P,T,E,w,l,v){T&&this.currentPos.top!=u.top&&(this.currentPos.top-=60),n.drawImage(a,P.left,P.top,P.width,P.height,E||this.currentPos.left,w||this.currentPos.top,l||g,v||m),this.currentPos.top+=m+80,this.countDraw++}examToPdf(n,a){return(0,S.mG)(this,void 0,void 0,function*(){this.countDraw=0,this.totalDraw=document.querySelectorAll(`.${this.exportPdfUtilsService.blockCropItemClass}`).length,this.pdfDoc=new A.jsPDF;let g=document.createElement("canvas"),m=document.getElementById("multipleChoiceWrap");if(m){let E=m.getBoundingClientRect().width;g.width=2*E,g.height=297*E/210*2}let P=g.getContext("2d");return this.exportPdfUtilsService.eraseCanvas(P),m&&this.resetPosition(m),m&&(yield this.drawBlockItemToPageForExam(P,m)),this.countDraw=this.totalDraw,yield this.exportPdfUtilsService.asyncTimeout(1e3),"class"==n?this.pdfDoc.output("blob"):(this.pdfDoc.save(a||"test_result.pdf"),!0)})}homeworkToPdf(){return(0,S.mG)(this,void 0,void 0,function*(){this.pdfDoc=new A.jsPDF;let n=document.createElement("canvas"),a=document.getElementById("multipleChoiceWrap");if(a){let P=a.getBoundingClientRect().width;n.width=P,n.height=297*P/210}let g=n.getContext("2d");return this.exportPdfUtilsService.eraseCanvas(g),a&&this.resetPosition(a),this.drawExamTitle(g),this.drawColLeftRightInHeaderOfExam(g),yield this.drawHomeworkNoteBoxOfTeacher(g),a&&(yield this.drawEssayIframeContent(g,a,!0)),this.pdfDoc.output("blob")})}}return f.\u0275fac=function(n){return new(n||f)(M.LFG(y.S),M.LFG(D.V),M.LFG(d.T),M.LFG(e.O))},f.\u0275prov=M.Yz7({token:f,factory:f.\u0275fac,providedIn:"root"}),f})()},20814:(N,L,p)=>{p.d(L,{V:()=>M});var S=p(70655),t=p(5e3),R=p(35018),A=p(15043),B=p(88161),I=(()=>{return(y=I||(I={}))[y.Cdn=0]="Cdn",y[y.CdnTimestamp=1]="CdnTimestamp",y[y.Rawlink=2]="Rawlink",y[y.RawlinkTimestamp=3]="RawlinkTimestamp",I;var y})();let M=(()=>{class y{constructor(d,e,i){this.commonService=d,this.cdnService=e,this.answerTypeService=i}get blockCropItemClass(){return"__CANVAS_CROP_ITEM"}get blockEssayCropItemClass(){return"_ESSAY"}isSupportedBrowswer(){var r,o,c;let e=(o=navigator.userAgent,c=o.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[],/trident/i.test(c[1])?"IE "+((r=/\brv[ :]+(\d+)/g.exec(o)||[])[1]||""):"Chrome"===c[1]&&null!=(r=o.match(/\b(OPR|Edge)\/(\d+)/))?r.slice(1).join(" ").replace("OPR","Opera"):(c=c[2]?[c[1],c[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(r=o.match(/version\/(\d+)/i))&&c.splice(1,1,r[1]),c.join(" "))).toString();return!(!["chrome"].includes(e.split(" ")[0].toLowerCase())||parseInt(e.split(" ")[1],10)<80)}getExtensionFile(d){if(!d)return"";var e=d.split(".");return e.length<=1?"":e[e.length-1].toLocaleLowerCase().split("_")[0]}translateMetaTitle(d){var e,i,o,r;let c="Export PDF: ";this.commonService.translateMetaData({title:c+(null===(i=null===(e=d.data)||void 0===e?void 0:e.examObj)||void 0===i?void 0:i.name),description:c+(null===(r=null===(o=d.data)||void 0===o?void 0:o.examObj)||void 0===r?void 0:r.name),image:"lang_cms_test_image"})}findImageSrcInContent(d){var e="";if(d.includes("img")){var i=d.indexOf("img"),o=d.indexOf("src=",i),r=d.indexOf('"',Number(o)+5);e=d.substring(Number(o)+5,Number(r))}return e}asyncTimeout(d){return(0,S.mG)(this,void 0,void 0,function*(){return`Waited ${yield new Promise(i=>{setTimeout(()=>i(d),d)})} miliseconds`})}parseEssayMarkResult(d,e,i){var o;let r=d.filter(h=>this.answerTypeService.isEssayAnswer(h.answerType));if(0!=r.length){if(e&&e.essayResult){var c=this.commonService.willDeleteParseJson(e.essayResult);if(c){var u=Object.entries(c);for(let h=0;h<r.length;h++)r[h].essayMarkParsed=u[h][1]}}for(let h=0;h<r.length;h++){let f=r[h].id,C=i.filter(a=>a.questionId==f)[0],n=this.commonService.willDeleteParseJson(null!==(o=C.config)&&void 0!==o?o:"");r[h].scorePerQuestion=n?Number(n.ScorePerQuestion):0}}}convertToBase64(d,e){return(0,S.mG)(this,void 0,void 0,function*(){let i=d;switch(e){case I.Cdn:i=this.cdnService.getMyCdn(d);break;case I.CdnTimestamp:i=this.cdnService.getMyCdn(d)+"?t="+Date.now();break;case I.RawlinkTimestamp:i=d+"?t="+Date.now()}const r=yield(yield fetch(i)).blob(),c=yield new Promise(u=>{const h=new FileReader;h.readAsDataURL(r),h.onloadend=()=>{u(h.result)}});return c&&"string"==typeof c?c:(console.log("kh\xf4ng th\u1ec3 convert url n\xe0y th\xe0nh chu\u1ed7i base64: "+d),d)})}convertAndRetryToBase64(d){return(0,S.mG)(this,void 0,void 0,function*(){let e=this.getExtensionFile(d);if(["pdf","jpg","jpeg","png","gif"].includes(e)){let i;const o=[I.Cdn,I.CdnTimestamp,I.Rawlink,I.RawlinkTimestamp];if(this.cdnService.isViettelCDN(d)){console.log(">>>> YAAAAAA, \u0111\xe2y l\xe0 link Viettel, qu\xe1 tr\xecnh convert c\xf3 th\u1ec3 l\xe2u h\u01a1n b\xecnh th\u01b0\u1eddng, v\xec ph\u1ea3i convert tu\u1ea7n t\u1ef1 sau m\u1ed7i 0.5 gi\xe2y");try{i=yield this.convertToBase64(d,o[0])}catch(r){try{yield this.asyncTimeout(500),i=yield this.convertToBase64(d,o[1])}catch(c){console.log("Kh\xf4ng th\u1ec3 convert url VIETTEL n\xe0y th\xe0nh base64 sau 2 l\u1ea7n th\u1eed: "+d),i=d}}}else try{i=yield this.convertToBase64(d,o[0])}catch(r){try{i=yield this.convertToBase64(d,o[1])}catch(c){try{i=yield this.convertToBase64(d,o[2])}catch(u){try{i=yield this.convertToBase64(d,o[3])}catch(h){console.log("Kh\xf4ng th\u1ec3 convert url n\xe0y th\xe0nh base64 sau v\xe0i l\u1ea7n retry: "+d),i=d}}}}return i}return console.log("\u0110\u1ecbnh d\u1ea1ng file kh\xf4ng \u0111\u01b0\u1ee3c h\u1ed7 tr\u1ee3: "+d),d})}eraseCanvas(d){d&&(d.beginPath(),d.rect(0,0,d.canvas.width,d.canvas.height),d.fillStyle="white",d.fill())}addContentToPdf(d,e){d.addImage(e,"JPEG",0,0,d.internal.pageSize.getWidth(),d.internal.pageSize.getHeight())}drawTextWrap(d,e,i,o,r){let c=d.split(" "),u=[],h=c[0];if(e){e.font=r||`${o}px Arial`;for(let f=1;f<c.length;f++){let C=c[f];e.measureText(h+" "+C).width<i?h+=" "+C:(u.push(h),h=C)}u.push(h)}return u}essayText2LinesArr(d,e,i,o,r){var c;let u=new RegExp("(<br>|<br/>)+","igm"),f=(null!==(c=this.commonService.replaceAllByRegExp(d,u,"<br>"))&&void 0!==c?c:"").split("<br>"),C=[];for(let n=0;n<f.length;n++)C.push(this.drawTextWrap(f[n],e,i,o,r));return C}}return y.\u0275fac=function(d){return new(d||y)(t.LFG(R.v),t.LFG(A.U),t.LFG(B.T))},y.\u0275prov=t.Yz7({token:y,factory:y.\u0275fac,providedIn:"root"}),y})()},50136:(N,L,p)=>{p.d(L,{J:()=>y});var S=p(40520),t=p(34202),R=p(51442),A=p(5e3),B=p(35018),I=p(12813),M=p(58326);let y=(()=>{class D{constructor(e,i,o){this.commonService=e,this.apiUploadService=i,this.myPdfService=o}replaceImageInContent(e){return new t.y(i=>{if(e.includes("<img ")){var o=this.findAllSubString(e,"<img"),r=[],c=[];o.forEach(u=>{var h=e.indexOf("src=",u),f=e.indexOf('"',Number(h)+5),C=e.substring(Number(h)+5,Number(f)+1);C.includes(";base64")?r.push({oldUrl:C}):C.includes("blob:")&&c.push({oldUrl:C})}),r.length>0?this.reUploadBase64File(r,(u,h)=>{null!=h?this.reUploadBlobFile(c,(f,C)=>{null!=C?(e=this.replaceHomeworkContent(e,u),e=this.replaceHomeworkContent(e,f),i.next({errorMessage:void 0,content:e}),i.complete()):(i.next({errorMessage:C,content:e}),i.complete())}):(i.next({errorMessage:h,content:e}),i.complete())}):c.length>0?this.reUploadBlobFile(c,(u,h)=>{null!=h?(e=this.replaceHomeworkContent(e,u),i.next({errorMessage:void 0,content:e}),i.complete()):(i.next({errorMessage:h,content:e}),i.complete())}):(e=this.replaceHomeworkContent(e,[]),i.next({errorMessage:void 0,content:e}),i.complete())}else i.next({errorMessage:void 0,content:e}),i.complete()})}replaceHomeworkContent(e,i){return i.length>0&&i.forEach(o=>{var r,c=e.replace(null!==(r=o.oldUrl)&&void 0!==r?r:"  ",o.newUrl+'" class="w-100 img-fluid"');e=c}),e}findAllSubString(e,i){for(var o=0,r=0,c=[];e.indexOf(i,o)>-1;)r=e.indexOf(i,o),c.push(r),o=r+i.length;return c}getTypeFile(e){var i=e.indexOf(";");return e.substring(5,i)}getFileName(e){var i=e.split("").reverse().join(""),o=i.indexOf(";"),r=i.indexOf("/",o);return i.substring(o,r).split("").reverse().join("")}convertBlobToBase64(e){return new Promise(i=>{var o=new Image;o.crossOrigin="Anonymous",o.addEventListener("load",function(){var r=document.createElement("canvas"),c=r.getContext("2d");r.width=o.width,r.height=o.height,null==c||c.drawImage(o,0,0);var u=r.toDataURL("image/png");i(u)},!1),o.src=e})}reUploadBase64File(e,i){var o;if(e&&e.length>0){let h,u=e.length;for(var r=[],c=0;c<e.length;c++){const f=e[c],C=null===(o=f.oldUrl)||void 0===o?void 0:o.substring(0,f.oldUrl.length-1);this.startUploadBlobFile(f,null!=C?C:"",[],(n,a)=>{null==a?r=r.concat(n):h=a,u-=1,0==u&&i(r,h)})}}else i([],"lang_auto_khong_upload_duoc_anh_vui_long_thu_lai_sau")}reUploadBlobFile(e,i){var o;if(e&&e.length>0){let h,u=e.length;for(var r=[],c=0;c<e.length;c++){const f=e[c],C=null===(o=null==f?void 0:f.oldUrl)||void 0===o?void 0:o.substring(0,f.oldUrl.length-1);this.convertBlobToBase64(null!=C?C:"").then(n=>{this.startUploadBlobFile(f,n,[],(a,g)=>{null==g?r=r.concat(a):h=g,u-=1,0==u&&i(r,h)})})}}else i([],"lang_auto_khong_upload_duoc_anh_vui_long_thu_lai_sau")}startUploadBlobFile(e,i,o,r){if(i&&""!=i){var c=this.getTypeFile(i),u=this.myPdfService.b64toFile(i,this.getFileName(c),c);(0,R.hv)(u).then(h=>{this.apiUploadService.uploadToCdnForHomework(h).subscribe(f=>{var C,n;if(f.type!=S.dt.UploadProgress)if(1==f.success){var a=Object.assign(Object.assign({},e),{newUrl:null!==(n=null===(C=f.data)||void 0===C?void 0:C.url)&&void 0!==n?n:""});o.push(a),r(o,void 0)}else r(o,"lang_auto_khong_upload_duoc_anh_vui_long_thu_lai_sau_loi[SPLIT_LANG] [SPLIT_LANG]"+f.message)})})}else r(o,"lang_auto_khong_upload_duoc_anh_vui_long_thu_lai_sau")}}return D.\u0275fac=function(e){return new(e||D)(A.LFG(B.v),A.LFG(I.$),A.LFG(M.t))},D.\u0275prov=A.Yz7({token:D,factory:D.\u0275fac,providedIn:"root"}),D})()}}]);